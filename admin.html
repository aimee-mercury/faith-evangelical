<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard • Faith Evangelical Church</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body{background:#f5f7fb}
        .topbar{background:#fff;box-shadow:0 8px 24px rgba(0,0,0,.08);position:sticky;top:0;z-index:10}
        .topbar .container{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
        .badge{background:var(--primary);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
        .wrap{padding:20px 0}
        .tools{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
        .card{background:#fff;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:16px}
        .grid{display:grid;grid-template-columns: 2fr 1fr;gap:16px}
        .table{width:100%;border-collapse:collapse}
        .table th,.table td{border-bottom:1px solid #eee;padding:10px;text-align:left}
        .table th{background:#fafafa}
        .table tr:hover{background:#fdf2f4}
        .table input{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;transition:border-color .2s, box-shadow .2s}
        .table input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(178,30,53,.15)}
        .btn.small{padding:8px 12px}
        .flex{display:flex;gap:8px;align-items:center}
        .preview{display:grid;gap:8px}
        .ocr-output{white-space:pre-wrap;background:#0b1021;color:#e8e8e8;border-radius:8px;padding:10px;max-height:200px;overflow:auto}
        @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        (function(){
            const AUTH_KEY='fec_auth';
            const STORE_KEY='fec_members_v1';
            function requireAuth(){
                try{ const auth=JSON.parse(localStorage.getItem(AUTH_KEY)||'null'); if(!auth) throw new Error(); }catch(e){ window.location.href='login.html'; }
            }
            function load(){ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); }
            function save(list){ localStorage.setItem(STORE_KEY, JSON.stringify(list)); }
            function addEmpty(){ const list=load(); list.push({ id: Date.now(), name:'', nationalId:'', phone:'', district:'', sector:'', village:'' }); save(list); render(); }
            function removeRow(rowId){ const list=load().filter(r=>r.id!==rowId); save(list); render(); }
            function updateField(rowId, field, value){ const list=load(); const idx=list.findIndex(r=>r.id===rowId); if(idx>-1){ list[idx][field]=value; save(list); }}
            // clearAll removed per request (no global deletion)
            function exportExcel(){ const list=load(); const ws=XLSX.utils.json_to_sheet(list.map(({id, ...rest})=>rest)); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Members'); XLSX.writeFile(wb, 'members.xlsx'); }
            function exportPdf(){
                const list=load();
                const { jsPDF } = window.jspdf;
                const doc=new jsPDF({ orientation:'landscape' });
                const head=[["Name","ID Number","Telephone","District","Sector","Village"]];
                const body=list.map(r=>[r.name||'', r.nationalId||'', r.phone||'', r.district||'', r.sector||'', r.village||'']);
                doc.text('Faith Evangelical Church — Members', 14, 12);
                doc.autoTable({ head, body, startY:16, styles:{ fontSize:8 } });
                doc.save('members.pdf');
            }
            async function exportWord(){
                const list=load();
                const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, HeadingLevel } = window.docx;
                const headerRow=new TableRow({ children:["Name","ID Number","Telephone","District","Sector","Village"].map(t=> new TableCell({ children:[new Paragraph({ children:[new TextRun({ text:t, bold:true })] })] })) });
                const rows=list.map(r=> new TableRow({ children:[r.name,r.nationalId,r.phone,r.district,r.sector,r.village].map(v=> new TableCell({ children:[new Paragraph(String(v||''))] })) }));
                const table=new Table({ rows:[headerRow, ...rows], width:{ size:100, type:WidthType.PERCENTAGE } });
                const doc=new Document({ sections:[{ children:[ new Paragraph({ text:'Faith Evangelical Church — Members', heading:HeadingLevel.HEADING_2 }), table ] }] });
                const blob=await Packer.toBlob(doc);
                const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='members.docx'; a.click();
                setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
            }
            function importExcel(file){ const reader=new FileReader(); reader.onload=e=>{ const wb=XLSX.read(new Uint8Array(e.target.result), {type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const data=XLSX.utils.sheet_to_json(ws); const normalized=data.map((r,i)=>({ id: Date.now()+i, name:r.name||r.Name||'', nationalId:r.nationalId||r["ID Number"]||r.id||'', phone:r.phone||r.Telephone||r.Phone||'', district:r.district||r.District||'', sector:r.sector||r.Sector||'', village:r.village||r.Village||'' })); const merged=[...load(), ...normalized]; save(merged); render(); }; reader.readAsArrayBuffer(file); }
            function parseTextToRows(text){
                const lines=text.split(/\n+/).map(l=>l.trim()).filter(Boolean);
                const rows=[];
                for(const line of lines){
                    const parts=line.split(/\s{2,}|\t|,|;\s*/).map(s=>s.trim()).filter(Boolean);
                    if(parts.length>=3){
                        rows.push({ id: Date.now()+Math.random(), name: parts[0], nationalId: parts[1]||'', phone: parts[2]||'', district: parts[3]||'', sector: parts[4]||'', village: parts[5]||'' });
                    }
                }
                return rows;
            }
            async function ocrImage(file){
                const { data } = await Tesseract.recognize(file, 'eng', { logger: m=>console.log(m) });
                return data.text || '';
            }
            async function startCameraOnce(){
                const video=document.getElementById('cam');
                if(!video.srcObject){
                    const stream=await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' } });
                    video.srcObject=stream; await video.play();
                }
            }
            async function captureAndOcr(){
                const video=document.getElementById('cam');
                const canvas=document.createElement('canvas');
                canvas.width=video.videoWidth; canvas.height=video.videoHeight;
                const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0);
                const dataUrl=canvas.toDataURL('image/png');
                const text=await ocrImage(dataUrl);
                document.getElementById('ocrOut').textContent=text.trim();
                const rows=parseTextToRows(text);
                if(rows.length){ const merged=[...load(), ...rows]; save(merged); render(); }
            }
            function render(){
                const tbody=document.getElementById('tbody');
                const list=load();
                tbody.innerHTML='';
                list.forEach(row=>{
                    const tr=document.createElement('tr');
                    tr.innerHTML=`
                        <td><input value="${row.name}" /></td>
                        <td><input value="${row.nationalId}" /></td>
                        <td><input value="${row.phone}" /></td>
                        <td><input value="${row.district}" /></td>
                        <td><input value="${row.sector}" /></td>
                        <td><input value="${row.village}" /></td>
                        <td><button class="btn small" data-del="${row.id}">Delete</button></td>
                    `;
                    const inputs=tr.querySelectorAll('input');
                    const fields=['name','nationalId','phone','district','sector','village'];
                    inputs.forEach((inp,i)=>{
                        inp.addEventListener('input',()=>updateField(row.id, fields[i], inp.value));
                    });
                    tr.querySelector('[data-del]').addEventListener('click',()=>removeRow(row.id));
                    tbody.appendChild(tr);
                });
                document.getElementById('count').textContent=String(list.length);
            }
            window.addEventListener('DOMContentLoaded',()=>{
                requireAuth();
                document.getElementById('add').addEventListener('click', addEmpty);
                document.getElementById('export').addEventListener('click', exportExcel);
                document.getElementById('exportPdf').addEventListener('click', exportPdf);
                document.getElementById('exportWord').addEventListener('click', exportWord);
                document.getElementById('importFile').addEventListener('change', e=>{ if(e.target.files[0]) importExcel(e.target.files[0]); e.target.value=''; });
                document.getElementById('imgFile').addEventListener('change', async e=>{ if(e.target.files[0]){ const text=await ocrImage(e.target.files[0]); document.getElementById('ocrOut').textContent=text.trim(); const rows=parseTextToRows(text); if(rows.length){ const merged=[...load(), ...rows]; save(merged); render(); } } e.target.value=''; });
                document.getElementById('startCam').addEventListener('click', startCameraOnce);
                document.getElementById('snap').addEventListener('click', captureAndOcr);
                document.getElementById('logout').addEventListener('click', ()=>{ localStorage.removeItem(AUTH_KEY); window.location.href='login.html'; });
                render();
            });
        })();
    </script>
</head>
<body>
    <div class="topbar">
        <div class="container">
            <div class="flex">
                <div class="logo-icon">FEC</div>
                <strong>Admin Dashboard</strong>
                <span class="badge" id="count">0</span>
            </div>
            <div class="flex">
                <a class="btn small" href="index.html">← Back to site</a>
                <button id="logout" class="btn small btn-secondary">Logout</button>
            </div>
        </div>
    </div>

    <div class="container wrap">
        <div class="grid">
            <div class="card">
                <div class="tools">
                    <button id="add" class="btn small">Add Row</button>
                    <label class="btn small btn-secondary" for="importFile">Import Excel</label>
                    <input id="importFile" type="file" accept=".xlsx,.xls" style="display:none">
                    <button id="export" class="btn small">Export Excel</button>
                    <button id="exportPdf" class="btn small">Export PDF</button>
                    <button id="exportWord" class="btn small">Export Word</button>
                </div>
                <div style="overflow:auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>ID Number</th>
                                <th>Telephone</th>
                                <th>District</th>
                                <th>Sector</th>
                                <th>Village</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3>Scan from Camera or Image</h3>
                <p class="muted">Use your camera or upload a photo of handwritten/typed names to auto-fill rows. Tip: write each person on a new line: “Name  ID  Phone  District  Sector  Village”.</p>
                <div class="preview">
                    <video id="cam" playsinline style="width:100%;max-height:220px;background:#000;border-radius:8px"></video>
                    <div class="flex">
                        <button id="startCam" class="btn small">Start Camera</button>
                        <button id="snap" class="btn small btn-secondary">Capture & OCR</button>
                        <label class="btn small" for="imgFile">Upload Image</label>
                        <input id="imgFile" type="file" accept="image/*" style="display:none" />
                    </div>
                    <div class="ocr-output" id="ocrOut"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


